services:
  localstack:
    image: localstack/localstack:latest
    container_name: smart-home-localstack
    environment:
      - SERVICES=sqs,s3
      - AWS_DEFAULT_REGION=us-west-2
      - DEBUG=1
      - DATA_DIR=/var/lib/localstack
      - PERSISTENCE=1
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"  # External services port range
    volumes:
      - "./localstack-data:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  postgres:
    image: postgres:15
    container_name: smart-home-postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=smart_home
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  mongo:
    image: mongo:7
    container_name: smart-home-mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 5

  mongo-express:
    image: mongo-express
    container_name: smart-home-mongo-express
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongo
      - ME_CONFIG_MONGODB_PORT=27017
      - ME_CONFIG_MONGODB_ENABLE_ADMIN=true
      - ME_CONFIG_BASICAUTH_USERNAME=admin
      - ME_CONFIG_BASICAUTH_PASSWORD=admin
    ports:
      - "8081:8081"
    depends_on:
      mongo:
        condition: service_healthy

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
    container_name: smart-home-api
    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
      localstack:
        condition: service_started
    environment:
      - DATABASE_URL=postgresql+psycopg2://postgres:postgres@postgres:5432/smart_home
      - MONGO_URI=mongodb://mongo:27017/smart_home
      - AWS_REGION=us-west-2
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_SQS_ENDPOINT_URL=http://localstack:4566
      - AWS_S3_ENDPOINT_URL=http://localstack:4566
      - AWS_S3_ENDPOINT_URL_FRONTEND=http://localhost:4566
      - S3_BUCKET=smart-home-audio
      - SQS_QUEUE_URL=http://localstack:4566/000000000000/ingest-queue
      - JWT_SECRET=changeme-in-production
      - JWT_ALGORITHM=HS256
      - FRONTEND_ORIGIN=http://localhost:3000
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    command: ["uv", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.worker
    container_name: smart-home-worker
    depends_on:
      - api
      - postgres
      - mongo
      - localstack
    environment:
      - DATABASE_URL=postgresql+psycopg2://postgres:postgres@postgres:5432/smart_home
      - MONGO_URI=mongodb://mongo:27017/smart_home
      - AWS_REGION=us-west-2
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_SQS_ENDPOINT_URL=http://localstack:4566
      - AWS_S3_ENDPOINT_URL=http://localstack:4566
      - S3_BUCKET=smart-home-audio
      - SQS_QUEUE_URL=http://localstack:4566/000000000000/ingest-queue
    volumes:
      - ./backend:/app
    command: ["uv", "run", "python", "-m", "worker.main"]

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: smart-home-frontend
    depends_on:
      - api
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NODE_ENV=development
      - WATCHPACK_POLLING=true
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    command: ["npm", "run", "dev"]

volumes:
  postgres-data:
  mongo-data:

